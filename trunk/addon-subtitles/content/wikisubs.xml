<?xml version="1.0"?>

<bindings id="wikisubsBindings"
   xmlns="http://www.mozilla.org/xbl"
   xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
   xmlns:xbl="http://www.mozilla.org/xbl"
	 xmlns:svg="http://www.w3.org/2000/svg" 
   xmlns:html="http://www.w3.org/1999/xhtml" 
>

  <binding id="wikisubs" extends="chrome://global/content/bindings/videocontrols.xml#videoControls">
      <implementation>
        <field name="wikisubsUtils">
            <![CDATA[ ({
                video : null,
                subtitlesMenu : null,
                button : null,
                current_subtitle : null,
                loading_subtitles : false,

                toMilliSeconds: function (s){
                  var timeparts = s.split('.');
                  var epoch = 'Jan 01, 1970';
                  var millisecondsEpoch = Date.parse(epoch);
                  var timestamp = epoch+' '+timeparts[0];
                  var milliseconds = Date.parse(timestamp) - millisecondsEpoch + parseInt(timeparts[1]);
                  return milliseconds;
                },

                parse_SRT : function (text){
                  var pairs = text.split("\n\n");
                  var content = [];
                  for (var i=0; i<pairs.length; i++){
                    var pair = pairs[i].split("\n");
                    var timeinterval = pair[0].split(',');
                    var start = this.toMilliSeconds(timeinterval[0]);
                    var end = this.toMilliSeconds(timeinterval[1]);
                    content.push({'start':start, 'end':end, 'text':pair[1]});
                  }
                  return content;
                },

                emit_event : function (eventName, node){
                  var evt = document.createEvent("Events");
                  evt.initEvent(eventName, true, false);
                  node.dispatchEvent(evt);
                },

                fetch : function (sub, node){
                  if (!node) node = this.ajax_element;
                  this.loading_subtitles = true;
                  sub["content"] = [];
                  this.current_subtitle = sub
                  this.ajax_element.setAttribute("src", sub["url"]); 
                  this.emit_event("WikiSubsLoadSub", node);
                },

                addSubtitle : function (sub){
                    var xulns = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
                    var item = document.createElementNS(xulns, "menuitem");
                    item.setAttribute("label", sub["title"]);
                    var self = this;

                    sub["itext_node"].addEventListener("DOMNodeInserted", function(event) { self.itextChildInserted(event); }, false);
                    item.addEventListener("click", function(e) {self.fetch(sub, sub["itext_node"]);}, false);
                    this.subtitlesMenu.appendChild(item);
                    this.subtitlesButton.setAttribute("hidden", "false");
                },

                displaySubtitles : function(){
                  var currentTime = Math.round(this.video.currentTime * 1000); // in ms
                  if (this.loading_subtitles == true) {
                  //TODO: l10n
                    this.subtitlesLabel.setAttribute("value", "Loading subtitles...");
                    return;
                  }

                  if (this.current_subtitle == null) return;

                  var text = "";
                  var subs = this.current_subtitle["content"];
                  for (i=0; i < subs.length; i++){
                    if ((currentTime >= subs[i].start) && (currentTime < subs[i].end)){
                      text = subs[i]["text"];
                      break;
                    }
                  }
                  this.subtitlesLabel.setAttribute("value", text);
                },

                look_for_available_subtitles : function(){
                    this.emit_event("WikiSubsLoadSubList", this.ajax_element);  
                },

//This is a test
//TODO: check whether it is a good thing. Otherwise, remove it.
                addBalloon : function(x,y,w,h,px,py, text){
                    var balloon = document.createElement("annotation");
                    balloon.setAttribute("id", "myballoon");
                    //this.annotations_overlay.appendChild(balloon);
                    document.addBinding(balloon, "chrome://global/content/annotations.xml#annotation");
 
                    update_balloon = function(evt){

                    var x = evt.clientX;
                    var y = evt.clientY;

                      balloon.setDimensions(20,70,50,40);
                      balloon.setPointer(x, y);
                      balloon.setText("X:"+x +" Y:"+ y);
                    }

                  window.onmousemove = update_balloon;
                },

                init : function (binding) {
                    dump("\n--------- wikisubs constructor ---------\n\n");

                    this.video = binding.parentNode;

                    this.ajax_element = document.createElement("WikiSubsAjaxElement");
                    this.video.appendChild(this.ajax_element);

                    // XBL doesn't have a good way to inject content into the middle of
                    // something else, so we'll insert our content via DOM manipulation.
                    var xulns = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
                    this.subtitlesButton = document.createElementNS(xulns, "button");
                    this.subtitlesButton.setAttribute("class", "subtitlesButton");
                    this.subtitlesButton.setAttribute("type", "menu");

                    this.subtitlesMenu = document.createElementNS(xulns, "menupopup");
                    this.subtitlesButton.appendChild(this.subtitlesMenu);
                    this.subtitlesButton.setAttribute("type", "menu");
                    this.subtitlesButton.setAttribute("position", "before_end");
                    this.subtitlesButton.setAttribute("dir", "reverse");

                    subtitlesHbox = document.createElementNS(xulns, "hbox");

                    spacer1 = document.createElementNS(xulns, "spacer");
                    spacer1.setAttribute("flex", "1");
                    this.subtitlesLabel = document.createElementNS(xulns, "label");
                    this.subtitlesLabel.setAttribute("class", "subtitlesLabel");
                    spacer2 = document.createElementNS(xulns, "spacer");
                    spacer2.setAttribute("flex", "1");

                    subtitlesHbox.setAttribute("class", "subsContainer");
                    subtitlesHbox.appendChild(spacer1);
                    subtitlesHbox.appendChild(this.subtitlesLabel);
                    subtitlesHbox.appendChild(spacer2);

                    var controlBar = document.getAnonymousElementByAttribute(binding, "class", "controlBar");

                    //Add label where the subtitle will be displayed:
                    controlBar.parentNode.insertBefore(subtitlesHbox, controlBar);

                    //Add subs button:
                    var muteButton = document.getAnonymousElementByAttribute(binding, "class", "muteButton");
                    muteButton.parentNode.insertBefore(this.subtitlesButton, muteButton);

                    //button is initially hidden while we dont have a list of available subs:
                    this.subtitlesButton.setAttribute("hidden", "true");

//setup annotations overlay:
                    statusOverlay = document.getAnonymousElementByAttribute(binding, "class", "statusOverlay");
                    this.annotations_overlay = document.createElementNS(xulns, "stack");
                    this.annotations_overlay.setAttribute("flex", "1");
                    statusOverlay.parentNode.insertBefore(this.annotations_overlay, statusOverlay);

                    this.addBalloon(0,0,10,10,20,30,"testing");

                    var self = this;
                    self.video.addEventListener("DOMNodeInserted", function(event) { self.videoChildInserted(event); }, false);
                    self.video.addEventListener("timeupdate", function() { self.displaySubtitles(); }, false);


//TODO: Why?!
                    //self.video.addEventListener("load", function(){ alert("self.video.src: "+self.video.src); self.look_for_available_subtitles(); }, false);
                    window.setInterval ( function(){ self.look_for_available_subtitles(); } );

                    dump("--- wikisubs initialized ---\n");
                },

                itextChildInserted : function(event) {
                        this.current_subtitle["content"] = this.parse_SRT(event.target.data);
                        this.loading_subtitles = false;
                },

                videoChildInserted : function(event) {
                    //this is an experiment. I am trying to implement behaviour proposed by Silvia Pfeiffer
                    //You can test it on http://bighead.poli.usp.br/~juca/teste/teste.html

                    if (event.target.tagName == "itext"){
                        this.addSubtitle({"title": event.target.id,
                          "lang": event.target.getAttribute("lang"),
                           "url": event.target.getAttribute("src"),
                            "itext_node": event.target });

                        this.subtitlesButton.setAttribute("hidden", "false");
                    }
                }
            }) ]]>
        </field>

        <constructor>
            <![CDATA[
                this.wikisubsUtils.init(this);
            ]]>
        </constructor>
      </implementation>

      <resources>
        <stylesheet src="chrome://wikisubs/skin/wikisubs.css"/>
      </resources>
  </binding>

</bindings>

